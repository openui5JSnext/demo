/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control'],function(q,l,C){"use strict";var T=C.extend("sap.ui.commons.Tree",{metadata:{library:"sap.ui.commons",properties:{title:{type:"string",group:"Misc",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'auto'},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:'auto'},showHeader:{type:"boolean",group:"Misc",defaultValue:true},showHeaderIcons:{type:"boolean",group:"Misc",defaultValue:true},showHorizontalScrollbar:{type:"boolean",group:"Misc",defaultValue:false},minWidth:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:null},selectionMode:{type:"sap.ui.commons.TreeSelectionMode",group:"Behavior",defaultValue:sap.ui.commons.TreeSelectionMode.Legacy}},defaultAggregation:"nodes",aggregations:{nodes:{type:"sap.ui.commons.TreeNode",multiple:true,singularName:"node",bindable:"bindable"}},events:{select:{allowPreventDefault:true,parameters:{node:{type:"sap.ui.commons.TreeNode"},nodeContext:{type:"object"}}},selectionChange:{parameters:{nodes:{type:"sap.ui.commons.TreeNode[]"},nodeContexts:{type:"object[]"}}}}}});T.prototype.resizeListenerId;T.prototype.init=function(){this.bAllCollapsed=false;this.allowTextSelection(false);this.iOldScrollTop=null;this.oSelectedNodeMap={};this.oSelectedContextMap={};this.aLeadSelection=null;this.bDelFlag=null;this.aExpandedTree=[];var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.commons");this.oCollapseAllButton=new sap.ui.commons.Button(this.getId()+"-CollapseAll",{icon:this.getIconPrefix()+"CollapseAll.png",tooltip:r.getText("TREE_COLLAPSE_ALL"),lite:true});this.oExpandAllButton=new sap.ui.commons.Button(this.getId()+"-ExpandAll",{icon:this.getIconPrefix()+"ExpandAll.png",tooltip:r.getText("TREE_EXPAND_ALL"),lite:true});this.oCollapseAllButton.attachPress(this.onCollapseAll,this);this.oExpandAllButton.attachPress(this.onExpandAll,this);this.oCollapseAllButton.addStyleClass("sapUiTreeCol");this.oExpandAllButton.addStyleClass("sapUiTreeExp")};T.prototype.exit=function(){if(this.oCollapseAllButton){this.oCollapseAllButton.destroy();this.oCollapseAllButton=null}if(this.oExpandAllButton){this.oExpandAllButton.destroy();this.oExpandAllButton=null}};T.SelectionType={Select:"Select",Toggle:"Toggle",Range:"Range"};T.prototype.onThemeChanged=function(){this.oCollapseAllButton.setIcon(this.getIconPrefix()+"CollapseAll.png");this.oExpandAllButton.setIcon(this.getIconPrefix()+"ExpandAll.png")};T.prototype.onExpandAll=function(){this.expandAll()};T.prototype.onCollapseAll=function(){this.collapseAll()};T.prototype.expandAll=function(){var n=this.getNodes();for(var i=0;i<n.length;i++){n[i].expand(true)}};T.prototype.collapseAll=function(){var n=this.getNodes();for(var i=0;i<n.length;i++){n[i].collapse(true)}};T.prototype.onsapdown=function(e){this.moveFocus(false);e.preventDefault()};T.prototype.onsapup=function(e){this.moveFocus(true);e.preventDefault()};T.prototype.onsaphome=function(e){this.placeFocus(this.getFirstSibling(e.target));e.preventDefault()};T.prototype.onsaphomemodifiers=function(e){this.placeFocus(this.getFirst());e.preventDefault()};T.prototype.onsapend=function(e){this.placeFocus(this.getLastSibling(e.target));e.preventDefault()};T.prototype.onsapendmodifiers=function(e){this.placeFocus(this.getLast());e.preventDefault()};T.prototype.onsapcollapseall=function(e){if(this.bAllCollapsed){this.expandAll()}else{this.collapseAll()}this.bAllCollapsed=!this.bAllCollapsed};T.prototype.getIconPrefix=function(){var i="themes/"+sap.ui.getCore().getConfiguration().getTheme()+"/";if(!sap.ui.getCore().getConfiguration().getRTL()){i+="img/tree/"}else{i+="img-RTL/tree/"}return sap.ui.resource("sap.ui.commons",i)};T.prototype.getFirstSibling=function(d){var D=q(d).siblings(".sapUiTreeNode:visible").first();if(D.length){return D[0]}return null};T.prototype.getLastSibling=function(d){var D=q(d).siblings(".sapUiTreeNode:visible").last();if(D.length){return D[0]}return null};T.prototype.getFirst=function(){var d=this.$().find(".sapUiTreeNode:visible").first();if(d.length){return d[0]}return null};T.prototype.getLast=function(){var d=this.$().find(".sapUiTreeNode:visible").last();if(d.length){return d[0]}return null};T.prototype.moveFocus=function(m){var a=q(".sapUiTreeNode:focus");if(a.length){var c=sap.ui.getCore().getControl(a[0].id);var d=this.$().find(".sapUiTreeNode:visible");var b=d.index(a[0]);var n=b;if(m){n--}else{n++}if(n>=0&&n<d.length){var D=d.eq(n);var N=sap.ui.getCore().getControl(D[0].id);c.blur();N.focus()}}};T.prototype.adjustFocus=function(){var f=this.$().find('.sapUiTreeNode[tabIndex="0"]');if(!f.is(':visible')){var d=this.$().find(".sapUiTreeNode");var a=d.index(f[0]);var D=d.filter(":lt("+a+")");var b=D.filter(":visible");var n=b[b.length-1];if(n){n.setAttribute("tabindex","0");if(q(".sapUiTreeNode:focus").is(":not(:visible)")){n.focus()}}}};T.prototype.placeFocus=function(d){if(!d){return}var D=this.$().find(".sapUiTreeNode[tabIndex='0']");if(D.length){D[0].setAttribute("tabindex","-1")}d.setAttribute("tabindex","0");var t=sap.ui.getCore().getControl(d.id);t.focus()};T.prototype.adjustSelectionOnExpanding=function(e){var t=this.$(),E=q(e),d,D;if(E.hasClass("sapUiTreeNodeSelectedParent")){E.removeClass("sapUiTreeNodeSelectedParent")}var $=t.find(".sapUiTreeNodeSelected:visible");if($.length){t.find(".sapUiTreeNodeSelectedParent").removeClass("sapUiTreeNodeSelectedParent")}else{d=t.find(".sapUiTreeNodeSelected");D=d.parent(".sapUiTreeChildrenNodes").prev(".sapUiTreeNode");while(D.length&&!D.is(":visible")){D=D.parent(".sapUiTreeChildrenNodes").prev(".sapUiTreeNode")}D.addClass("sapUiTreeNodeSelectedParent")}};T.prototype.adjustSelectionOnCollapsing=function(d){var t=this;if(this.getSelectionMode()!=sap.ui.commons.TreeSelectionMode.Multi){var D=q(d),c="#"+D.attr("id")+"-children",$=D.siblings(c).find(".sapUiTreeNodeSelected"),a=D.siblings(c).find(".sapUiTreeNodeSelectedParent");if($.length||a.length){D.addClass("sapUiTreeNodeSelectedParent");if(a.length){a.removeClass("sapUiTreeNodeSelectedParent")}}}else{var D=q(d),c="#"+D.attr("id")+"-children",$=D.siblings(c).find(".sapUiTreeNodeSelected");var s=$.control();if(s){if(q.isEmptyObject(s)==false){q.each(s,function(i,n){t._delMultiSelection(n)})}}}};T.prototype.isTreeBinding=function(n){return(n=="nodes")};T.prototype.updateNodes=function(){var c=this.oSelectedContext,n;this.updateAggregation("nodes");if(c){n=this.getNodeByContext(c);this.setSelection(n,true)}};T.prototype.getNodeByContext=function(c){return this.findNode(this,function(n){return n.getBindingContext()==c})};T.prototype.findNode=function(n,m){var f,t=this;if(m(n)){return n}q.each(n.getNodes(),function(i,n){f=t.findNode(n,m);if(f){return false}});return f};T.prototype.setSelectionMode=function(m){m=this.validateProperty("selectionMode",m);if(this.getSelectionMode()!=m){this.setProperty("selectionMode",m);this._delSelection()}};T.prototype.getSelection=function(){for(var i in this.oSelectedNodeMap){return this.oSelectedNodeMap[i]}return null};T.prototype.setSelection=function(n,s,t,d){var D=true;if(!s){D=this.fireSelect({node:n,nodeContext:n&&n.getBindingContext()})}if(D){switch(this.getSelectionMode()){case sap.ui.commons.TreeSelectionMode.Legacy:case sap.ui.commons.TreeSelectionMode.Single:this._setSelectedNode(n,s);break;case sap.ui.commons.TreeSelectionMode.Multi:if(t==T.SelectionType.Range){this._setSelectedNodeMapRange(n,s)}else if(t==T.SelectionType.Toggle){this._setSelectedNodeMapToggle(n,s)}else{this._setSelectedNode(n,s)}break;case sap.ui.commons.TreeSelectionMode.None:break}}};T.prototype.onAfterRendering=function(){if(this.iOldScrollTop){this.$("TreeCont").scrollTop(this.iOldScrollTop)}};T.prototype.invalidate=function(){C.prototype.invalidate.apply(this,arguments);this.oSelectedNodeMap={};this.oSelectedContextMap={};this.updateSelection(this,true)};T.prototype.updateSelection=function(n,e){var t=this;q.each(n.getNodes(),function(i,n){if(n.getIsSelected()){switch(t.getSelectionMode()){case sap.ui.commons.TreeSelectionMode.None:q.sap.log.warning("Added selected nodes in a tree with disabled selection");n.setIsSelected(false);break;case sap.ui.commons.TreeSelectionMode.Legacy:if(q.isEmptyObject(t.oSelectedNodeMap)){t.oSelectedNodeMap[n.getId()]=n}break;case sap.ui.commons.TreeSelectionMode.Single:if(q.isEmptyObject(t.oSelectedNodeMap)==false){q.sap.log.warning("Added multiple selected nodes in single select tree");n.setIsSelected(false)}else{t.oSelectedNodeMap[n.getId()]=n}break;case sap.ui.commons.TreeSelectionMode.Multi:if(!e){q.sap.log.warning("Added selected node inside collapsed node in multi select tree");n.setIsSelected(false)}else{t.oSelectedNodeMap[n.getId()]=n}break}}t.updateSelection(n,e&&n.getExpanded())})};T.prototype.onBeforeRendering=function(){this.iOldScrollTop=this.$("TreeCont").scrollTop()};T.prototype._setSelectedNode=function(n,s){var t=this;q.each(this.oSelectedNodeMap,function(i,n){t._delMultiSelection(n,s)});n._select(s,true);this.oSelectedNodeMap[n.getId()]=n;this.oSelectedContextMap[n.getId()]=n&&n.getBindingContext();this.oLeadSelection=n;if(!s){this.fireSelectionChange({nodes:[n],nodeContexts:[n&&n.getBindingContext()]})}};T.prototype._setSelectedNodeMapToggle=function(n,s){this._setNodeSelection(n,!n.getIsSelected(),s)};T.prototype._setSelectedNodeMapRange=function(n,s){var N=[],c=[];var t=this;if(this.bDelFlag==true){q.each(this.oSelectedNodeMap,function(I,n){t._delMultiSelection(n,s)})}if(this.oSelectedNodeMap[n.getId()]==n){return}else{this.aExpandedTree.length=0;var N=n.getTree().getNodes();var i,a,b;if(N.length>0){this._getSelectableNodes(N);var S=this.aExpandedTree.indexOf(this.oLeadSelection);var e=this.aExpandedTree.indexOf(n);if(S<e){a=S;b=e}else{a=e;b=S}for(i=a;i<=b;i++){var o=this.aExpandedTree[i];this._setMultiSelection(o,s)}}}if(!s){q.map(this.oSelectedNodeMap,function(I,n){N.push(n)});q.map(this.oSelectedContextMap,function(I,n){c.push(n)});this.fireSelectionChange({nodes:N,nodeContexts:c})}};T.prototype._getSelectableNodes=function(n){if(n.length>0){var i;for(i=0;i<n.length;i++){var N=n[i];if(N.getSelectable()){this.aExpandedTree.push(N)}if(N.getExpanded()){var s=N.getNodes();this._getSelectableNodes(s)}}}};T.prototype._setNodeSelection=function(n,i,s){var N=[],a=[];this.bDelFlag=true;if(i){this._setMultiSelection(n,s);this.oLeadSelection=n}else{this._delMultiSelection(n,s);this.oLeadSelection=n}if(!s){q.map(this.oSelectedNodeMap,function(I,n){N.push(n)});q.map(this.oSelectedContextMap,function(I,n){a.push(n)});this.fireSelectionChange({nodes:N,nodeContexts:a})}};T.prototype._setMultiSelection=function(s,S){if(!s){return}s._select(S);this.oSelectedNodeMap[s.getId()]=s;this.oSelectedContextMap[s.getId()]=s.getBindingContext()};T.prototype._delMultiSelection=function(s,S){if(!s){return}s._deselect();delete this.oSelectedNodeMap[s.getId()];delete this.oSelectedContextMap[s.getId()]};T.prototype._delSelection=function(){var t=this;if(this.oSelectedNode){this.oSelectedNode._deselect()}if(q.isEmptyObject(this.oSelectedNodeMap)==false){q.each(this.oSelectedNodeMap,function(i,n){t._delMultiSelection(n)})}};return T},true);
