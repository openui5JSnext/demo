/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/core/LocaleData','sap/ui/core/delegate/ItemNavigation','sap/ui/model/type/Date','./library'],function(q,C,L,I,D,l){"use strict";var a=C.extend("sap.ui.unified.Calendar",{metadata:{library:"sap.ui.unified",properties:{intervalSelection:{type:"boolean",group:"Misc",defaultValue:false},singleSelection:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{selectedDates:{type:"sap.ui.unified.DateRange",multiple:true,singularName:"selectedDate"},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"}},events:{select:{},cancel:{}}}});(function(){a.prototype.init=function(){this._mouseMoveProxy=q.proxy(this._handleMouseMove,this);this._iMode=0;this._oFormatYyyymmdd=sap.ui.core.format.DateFormat.getInstance({pattern:"yyyyMMdd"});this.data("sap-ui-fastnavgroup","true",true)};a.prototype.exit=function(){if(this._sRenderMonth){q.sap.clearDelayedCall(this._sRenderMonth)}};a.prototype.onAfterRendering=function(){var i=this;e(i);u(i)};a.prototype.invalidate=function(O){if(!O||!(O instanceof sap.ui.unified.DateRange)){C.prototype.invalidate.apply(this,arguments)}else if(this.getDomRef()&&this._iMode==0&&!this._sRenderMonth){var i=this;this._sRenderMonth=q.sap.delayedCall(0,this,f,[i])}};a.prototype.setLocale=function(i){if(this._sLocale!=i){this._sLocale=i;this._oLocaleData=undefined;this.invalidate()}return this};a.prototype.getLocale=function(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString()}return this._sLocale};a.prototype._getFocusedDate=function(){if(!this._oFocusedDate){var i=this;k(i)}return this._oFocusedDate};a.prototype._setFocusedDate=function(i){this._oFocusedDate=new Date(i)};a.prototype.focusDate=function(i){if(i&&!this._oFocusedDate||this._oFocusedDate.getTime()!=i.getTime()){this._setFocusedDate(h(i));if(this.getDomRef()&&this._iMode==0){var w=this;f(w)}}};a.prototype.setPopupMode=function(P){this._bPoupupMode=P};a.prototype._getLocaleData=function(){if(!this._oLocaleData){var i=this.getLocale();var w=new sap.ui.core.Locale(i);this._oLocaleData=L.getInstance(w)}return this._oLocaleData};a.prototype.onclick=function(E){if(E.isMarked("delayedMouseEvent")){return}var i=this;var F=this._getFocusedDate();if(q.sap.containsOrEquals(this.getDomRef("next"),E.target)){switch(this._iMode){case 0:F.setUTCMonth(F.getUTCMonth()+1,1);f(i);break;case 1:F.setUTCFullYear(F.getUTCFullYear()+1);this.$("year").text(F.getUTCFullYear());break;case 2:t(i,true,this._oItemNavigation.getFocusedIndex());break}}else if(q.sap.containsOrEquals(this.getDomRef("prev"),E.target)){switch(this._iMode){case 0:F.setUTCDate(1);F.setUTCDate(F.getUTCDate()-1);f(i);break;case 1:F.setUTCFullYear(F.getUTCFullYear()-1);this.$("year").text(F.getUTCFullYear());break;case 2:t(i,false,this._oItemNavigation.getFocusedIndex());break}}else if(E.target.id==this.getId()+"-month"){if(this._iMode!=1){m(i)}else{n(i)}this.addDelegate(this._oItemNavigation)}else if(E.target.id==this.getId()+"-year"){if(this._iMode!=2){p(i)}else{r(i)}this.addDelegate(this._oItemNavigation)}else if(E.target.id==this.getId()+"-cancel"){this.onsapescape(E)}};a.prototype._handleMouseMove=function(E){if(!this.$().is(":visible")){q(window.document).unbind('mousemove',this._mouseMoveProxy);this._bMouseMove=undefined}var T=q(E.target);if(T.hasClass("sapUiCalDayNum")){T=T.parent()}if(T.hasClass("sapUiCalDay")){var F=this._getFocusedDate();var O=F;F=this._oFormatYyyymmdd.parse(T.attr("data-sap-day"),true);this._setFocusedDate(F);if(F.getTime()!=O.getTime()){var i=this;if(T.hasClass("sapUiCalDayOtherMonth")){f(i)}else{j(i,F,false,true);this._bMoveChange=true}}}};a.prototype.onmouseup=function(E){if(this._bMouseMove){q(window.document).unbind('mousemove',this._mouseMoveProxy);this._bMouseMove=undefined;var F=this._getFocusedDate();var w=this.$("days").children(".sapUiCalDay");for(var i=0;i<w.length;i++){var $=q(w[i]);if(!$.hasClass("sapUiCalDayOtherMonth")){if($.attr("data-sap-day")==this._oFormatYyyymmdd.format(F,true)){$.focus();break}}}if(this._bMoveChange){var x=this;j(x,F);this._bMoveChange=false;v(x)}}};a.prototype.onsapselect=function(E){var i=this;var w=0;switch(this._iMode){case 0:if(q.sap.containsOrEquals(this.getDomRef("days"),E.target)){j(i,i._getFocusedDate());v(i);E.stopPropagation();E.preventDefault()}break;case 1:if(q.sap.containsOrEquals(this.getDomRef("months"),E.target)){w=this._oItemNavigation.getFocusedIndex();o(i,w)}break;case 2:if(q.sap.containsOrEquals(this.getDomRef("years"),E.target)){w=this._oItemNavigation.getFocusedIndex();s(i,w)}break}};a.prototype.onsapselectmodifiers=function(E){this.onsapselect(E)};a.prototype.onsapescape=function(E){var i=this;switch(this._iMode){case 0:this.fireCancel();break;case 1:n(i);break;case 2:r(i);break}};a.prototype.onsapshow=function(E){if(this._bPoupupMode){var i=this;switch(this._iMode){case 1:n(i);break;case 2:r(i);break}this.fireCancel();E.preventDefault()}};a.prototype.onsaphide=a.prototype.onsapshow;a.prototype.onsappageupmodifiers=function(E){if(q.sap.containsOrEquals(this.getDomRef("days"),E.target)){var F=this._getFocusedDate();var i=this;var y=F.getUTCFullYear();if(E.metaKey||E.ctrlKey){F.setUTCFullYear(y-10)}else{F.setUTCFullYear(y-1)}f(i)}E.preventDefault()};a.prototype.onsappagedownmodifiers=function(E){if(q.sap.containsOrEquals(this.getDomRef("days"),E.target)){var F=this._getFocusedDate();var i=this;var y=F.getUTCFullYear();if(E.metaKey||E.ctrlKey){F.setUTCFullYear(y+10)}else{F.setUTCFullYear(y+1)}f(i)}E.preventDefault()};a.prototype.onsappageup=function(E){if(E.target.id==this.getId()+"-month"||E.target.id==this.getId()+"-year"){E.preventDefault()}};a.prototype.onsappagedown=a.prototype.onsappageup;a.prototype.onsaptabnext=function(E){if(q.sap.containsOrEquals(this.getDomRef("days"),E.target)||q.sap.containsOrEquals(this.getDomRef("months"),E.target)||q.sap.containsOrEquals(this.getDomRef("years"),E.target)){q.sap.focus(this.getDomRef("month"));if(!this._bPoupupMode){q(this._oItemNavigation.getItemDomRefs()[this._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1")}this.removeDelegate(this._oItemNavigation);E.preventDefault()}else if(E.target.id==this.getId()+"-month"){q.sap.focus(this.getDomRef("year"));this.removeDelegate(this._oItemNavigation);E.preventDefault()}else if(E.target.id==this.getId()+"-year"){this.addDelegate(this._oItemNavigation)}};a.prototype.onsaptabprevious=function(E){if(q.sap.containsOrEquals(this.getDomRef("days"),E.target)||q.sap.containsOrEquals(this.getDomRef("months"),E.target)||q.sap.containsOrEquals(this.getDomRef("years"),E.target)){if(this._bPoupupMode){q.sap.focus(this.getDomRef("year"));this.removeDelegate(this._oItemNavigation);E.preventDefault()}}else if(E.target.id==this.getId()+"-month"){this.addDelegate(this._oItemNavigation);this._oItemNavigation.focusItem(this._oItemNavigation.getFocusedIndex());E.preventDefault()}else if(E.target.id==this.getId()+"-year"){q.sap.focus(this.getDomRef("month"));E.preventDefault()}};a.prototype.onsapnext=function(E){if(E.target.id==this.getId()+"-month"||E.target.id==this.getId()+"-year"){E.preventDefault()}};a.prototype.onsapprevious=a.prototype.onsapnext;a.prototype.onfocusin=function(E){if(E.target.id==this.getId()+"-end"){q.sap.focus(this.getDomRef("year"));q(this._oItemNavigation.getItemDomRefs()[this._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1");this.removeDelegate(this._oItemNavigation)}q.sap.byId(this.getId()+"-end").attr("tabindex","-1")};a.prototype.onsapfocusleave=function(E){if(!E.relatedControlId||!q.sap.containsOrEquals(this.getDomRef(),sap.ui.getCore().byId(E.relatedControlId).getFocusDomRef())){q.sap.byId(this.getId()+"-end").attr("tabindex","0");this.addDelegate(this._oItemNavigation)}};a.prototype._checkDateSelected=function(w){var S=0;var x=this.getSelectedDates();var T=w.getTime();for(var i=0;i<x.length;i++){var R=x[i];var y=h(R.getStartDate());var z;var A=0;if(y){z=y;A=z.getTime()}var E;var B=0;if(this.getIntervalSelection()){y=h(R.getEndDate());if(y){E=y;B=E.getTime()}}if(T==A&&!E){S=1;break}else if(T==A&&E){S=2;if(E&&T==B){S=5}break}else if(E&&T==B){S=3;break}else if(E&&T>A&&T<B){S=4;break}if(this.getSingleSelection()){break}}return S};a.prototype._getDateType=function(w){var T;var S=this.getSpecialDates();var x=w.getTime();for(var i=0;i<S.length;i++){var R=S[i];var y=h(R.getStartDate());var z;var A=0;if(y){z=y;A=z.getTime()}var E;var B=0;y=h(R.getEndDate());if(y){E=y;B=E.getTime()}if((x==A&&!E)||(x>=A&&x<=B)){T={type:R.getType(),tooltip:R.getTooltip_AsString()};break}}return T};function _(w){var x=w.getParameter("index");var E=w.getParameter("event");if(!E){return}var y=this;var F=this._getFocusedDate();if(this._iMode==0){var z=this.$("days").children(".sapUiCalDay");var i=0;var $=q(z[x]);var A;if($.hasClass("sapUiCalDayOtherMonth")){if(E.type=="saphomemodifiers"&&(E.metaKey||E.ctrlKey)){F.setUTCDate(1);for(i=0;i<z.length;i++){A=q(z[i]);if(this._oFormatYyyymmdd.parse(A.attr("data-sap-day"),true).getUTCDate()==1){this._oItemNavigation.focusItem(i);break}}}else if(E.type=="sapendmodifiers"&&(E.metaKey||E.ctrlKey)){for(i=z.length-1;i>0;i--){A=q(z[i]);if(!A.hasClass("sapUiCalDayOtherMonth")){F=this._oFormatYyyymmdd.parse(A.attr("data-sap-day"),true);this._setFocusedDate(F);this._oItemNavigation.focusItem(i);break}}}else{F=this._oFormatYyyymmdd.parse($.attr("data-sap-day"),true);this._setFocusedDate(F);f(y)}}else{if(!q(E.target).hasClass("sapUiCalWeekNum")){F=this._oFormatYyyymmdd.parse($.attr("data-sap-day"),true);this._setFocusedDate(F)}}}if(E.type=="mousedown"){c(y,E,F,x)}}function b(i){var w=i.getParameter("index");var E=i.getParameter("event");if(!E){return}if(E.type=="mousedown"){var x=this;var F=this._getFocusedDate();c(x,E,F,w)}}function c(T,E,F,i){switch(T._iMode){case 0:j(T,F,E.shiftKey);v(T);if(T.getIntervalSelection()&&T.$().is(":visible")){q(window.document).bind('mousemove',T._mouseMoveProxy);T._bMouseMove=true}break;case 1:o(T,i);break;case 2:s(T,i);break}E.preventDefault();E.setMark("cancelAutoClose")}function d(i){var E=i.getParameter("event");var M=0;var F=this._getFocusedDate();if(E.type){var w=this;switch(this._iMode){case 0:switch(E.type){case"sapnext":case"sapnextmodifiers":if(E.keyCode==q.sap.KeyCodes.ARROW_DOWN){F.setUTCDate(F.getUTCDate()+7)}else{F.setUTCDate(F.getUTCDate()+1)}break;case"sapprevious":case"sappreviousmodifiers":if(E.keyCode==q.sap.KeyCodes.ARROW_UP){F.setUTCDate(F.getUTCDate()-7)}else{F.setUTCDate(F.getUTCDate()-1)}break;case"sappagedown":M=F.getUTCMonth()+1;F.setUTCMonth(M);if(M%12!=F.getUTCMonth()){while(M!=F.getUTCMonth()){F.setUTCDate(F.getUTCDate()-1)}}break;case"sappageup":M=F.getUTCMonth()-1;F.setUTCMonth(M);if(M<0){M=11}if(M!=F.getUTCMonth()){while(M!=F.getUTCMonth()){F.setUTCDate(F.getUTCDate()-1)}}break;default:break}f(w);break;case 1:break;case 2:switch(E.type){case"sapnext":case"sapnextmodifiers":if(E.keyCode==q.sap.KeyCodes.ARROW_DOWN){t(w,true,this._oItemNavigation.getFocusedIndex()-16)}else{t(w,true,0)}break;case"sapprevious":case"sappreviousmodifiers":if(E.keyCode==q.sap.KeyCodes.ARROW_UP){t(w,false,16+this._oItemNavigation.getFocusedIndex())}else{t(w,false,19)}break;case"sappagedown":t(w,true,this._oItemNavigation.getFocusedIndex());break;case"sappageup":t(w,false,this._oItemNavigation.getFocusedIndex());break;default:break}break}}}function e(T){var w=T._getFocusedDate();var y=T._oFormatYyyymmdd.format(w,true);var x=[];var R;var z=0;var A=0;var N=false;var B=true;switch(T._iMode){case 0:R=T.$("days").get(0);x=T.$("days").children(".sapUiCalDay");for(var i=0;i<x.length;i++){var $=q(x[i]);if($.attr("data-sap-day")===y){z=i}}A=7;N=true;B=false;break;case 1:R=T.$("months").get(0);x=T.$("months").children(".sapUiCalMonth");z=w.getUTCMonth();A=3;break;case 2:R=T.$("years").get(0);x=T.$("years").children(".sapUiCalYear");z=10;A=4;N=true;B=false;break}if(!T._oItemNavigation){T._oItemNavigation=new I();T._oItemNavigation.attachEvent(I.Events.AfterFocus,_,T);T._oItemNavigation.attachEvent(I.Events.FocusAgain,b,T);T._oItemNavigation.attachEvent(I.Events.BorderReached,d,T);T.addDelegate(T._oItemNavigation);T._oItemNavigation.setHomeEndColumnMode(true,true);T._oItemNavigation.setDisabledModifiers({sapnext:["alt"],sapprevious:["alt"],saphome:["alt"],sapend:["alt"]})}T._oItemNavigation.setRootDomRef(R);T._oItemNavigation.setItemDomRefs(x);T._oItemNavigation.setCycling(B);T._oItemNavigation.setColumns(A,N);T._oItemNavigation.setFocusedIndex(z);T._oItemNavigation.setPageSize(x.length)}function f(T){T._sRenderMonth=undefined;var i=T._getFocusedDate();var $=T.$("days");if($.length>0){var R=sap.ui.getCore().createRenderManager();T.getRenderer().renderDays(R,T,i);R.flush($[0]);R.destroy()}T.fireEvent("_renderMonth",{days:$.children(".sapUiCalDay").length});var M=[];if(T._bLongMonth||!T._bNamesLengthChecked){M=T._getLocaleData().getMonthsStandAlone("wide")}else{M=T._getLocaleData().getMonthsStandAlone("abbreviated")}T.$("month").text(M[i.getUTCMonth()]);T.$("year").text(i.getUTCFullYear());e(T);T._oItemNavigation.focusItem(T._oItemNavigation.getFocusedIndex())}function g(i){if(i){return new Date(i.getTime()+i.getTimezoneOffset()*60000)}}function h(i){if(i){return new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate()))}}function j(T,w,x,M){var S=T.getSelectedDates();var y;var z=T.$("days").children(".sapUiCalDay");var $;var Y;var i=0;if(T.getSingleSelection()){var A;if(S.length>0){y=S[0];A=h(y.getStartDate())}else{y=new sap.ui.unified.DateRange();T.addAggregation("selectedDates",y,true)}if(T.getIntervalSelection()&&(!y.getEndDate()||M)&&A){var E;if(w.getTime()<A.getTime()){E=A;A=w;if(!M){y.setProperty("startDate",g(A),true);y.setProperty("endDate",g(E),true)}}else if(w.getTime()>=A.getTime()){E=w;if(!M){y.setProperty("endDate",g(E),true)}}var B;for(i=0;i<z.length;i++){$=q(z[i]);B=T._oFormatYyyymmdd.parse($.attr("data-sap-day"),true);if(B.getTime()==A.getTime()){$.addClass("sapUiCalDaySelStart");$.addClass("sapUiCalDaySel");if(E&&B.getTime()==E.getTime()){$.addClass("sapUiCalDaySelEnd")}}else if(E&&B.getTime()>A.getTime()&&B.getTime()<E.getTime()){$.addClass("sapUiCalDaySel");$.addClass("sapUiCalDaySelBetween")}else if(E&&B.getTime()==E.getTime()){$.addClass("sapUiCalDaySelEnd");$.addClass("sapUiCalDaySel")}else{if($.hasClass("sapUiCalDaySel")){$.removeClass("sapUiCalDaySel")}if($.hasClass("sapUiCalDaySelStart")){$.removeClass("sapUiCalDaySelStart")}else if($.hasClass("sapUiCalDaySelBetween")){$.removeClass("sapUiCalDaySelBetween")}else if($.hasClass("sapUiCalDaySelEnd")){$.removeClass("sapUiCalDaySelEnd")}}}}else{Y=T._oFormatYyyymmdd.format(w,true);for(i=0;i<z.length;i++){$=q(z[i]);if(!$.hasClass("sapUiCalDayOtherMonth")&&$.attr("data-sap-day")==Y){$.addClass("sapUiCalDaySel")}else if($.hasClass("sapUiCalDaySel")){$.removeClass("sapUiCalDaySel")}if($.hasClass("sapUiCalDaySelStart")){$.removeClass("sapUiCalDaySelStart")}else if($.hasClass("sapUiCalDaySelBetween")){$.removeClass("sapUiCalDaySelBetween")}else if($.hasClass("sapUiCalDaySelEnd")){$.removeClass("sapUiCalDaySelEnd")}}y.setProperty("startDate",g(w),true);y.setProperty("endDate",undefined,true)}}else{if(T.getIntervalSelection()){throw new Error("Calender don't support multiple interval selection")}else{var F=T._checkDateSelected(w);if(F>0){for(i=0;i<S.length;i++){if(S[i].getStartDate()&&w.getTime()==h(S[i].getStartDate()).getTime()){T.removeAggregation("selectedDates",i,true);break}}}else{y=new sap.ui.unified.DateRange({startDate:g(w)});T.addAggregation("selectedDates",y,true)}Y=T._oFormatYyyymmdd.format(w,true);for(i=0;i<z.length;i++){$=q(z[i]);if(!$.hasClass("sapUiCalDayOtherMonth")&&$.attr("data-sap-day")==Y){if(F>0){$.removeClass("sapUiCalDaySel")}else{$.addClass("sapUiCalDaySel")}}}}}}function k(T){var S=T.getSelectedDates();if(S&&S[0]&&S[0].getStartDate()){T._oFocusedDate=h(S[0].getStartDate())}else{var i=new Date();T._oFocusedDate=h(i)}}function m(T){if(T._iMode==2){r(T)}var i=T._getFocusedDate();var R=sap.ui.getCore().createRenderManager();var $=T.$();T.getRenderer().renderMonthPicker(R,T,i);R.flush($[0],false,true);R.destroy();T._iMode=1;q(T._oItemNavigation.getItemDomRefs()[T._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1");e(T);q.sap.focus(T._oItemNavigation.getItemDomRefs()[T._oItemNavigation.getFocusedIndex()])}function n(T){T.$("months").remove();T._iMode=0;e(T);q.sap.focus(T._oItemNavigation.getItemDomRefs()[T._oItemNavigation.getFocusedIndex()])}function o(T,M){var F=T._getFocusedDate();F.setUTCMonth(M);if(M!=F.getUTCMonth()){F.setUTCDate(0)}f(T);n(T)}function p(T){if(T._iMode==1){n(T)}var i=T._getFocusedDate();var R=sap.ui.getCore().createRenderManager();var $=T.$();T.getRenderer().renderYearPicker(R,T,i);R.flush($[0],false,true);R.destroy();var w=T.$("days").children(".sapUiCalDay");if(w.length==28){T.$("years").addClass("sapUiCalYearNoTop")}T._iMode=2;q(T._oItemNavigation.getItemDomRefs()[T._oItemNavigation.getFocusedIndex()]).attr("tabindex","-1");e(T);q.sap.focus(T._oItemNavigation.getItemDomRefs()[T._oItemNavigation.getFocusedIndex()])}function r(T){T.$("years").remove();T._iMode=0;e(T);q.sap.focus(T._oItemNavigation.getItemDomRefs()[T._oItemNavigation.getFocusedIndex()])}function s(T,i){var F=T._getFocusedDate();var w=T.$("years").children(".sapUiCalYear");var y=q(w[i]).text();F.setUTCFullYear(y);f(T);r(T)}function t(T,F,S){var w=T.$("years").children(".sapUiCalYear");var x=parseInt(q(w[0]).text(),10);var y=T._getFocusedDate();var z=y.getUTCFullYear().toString();if(F){x=x+20}else{x=x-20}var Y=x;for(var i=0;i<w.length;i++){var $=q(w[i]);$.attr("id",T.getId()+"-y"+Y);$.text(Y);if($.hasClass("sapUiCalYearSel")&&$.text()!=z){$.removeClass("sapUiCalYearSel")}else if(!$.hasClass("sapUiCalYearSel")&&$.text()==z){$.addClass("sapUiCalYearSel")}Y++}T._oItemNavigation.focusItem(S)}function u(T){if(!T._bNamesLengthChecked){var i=0;var w;var x;var W=T.$().children(".sapUiCalWH");var y=false;for(i=0;i<W.length;i++){w=W[i];if(w.clientWidth<w.scrollWidth){y=true;break}}if(y){T._bLongWeekDays=false;x=T._getLocaleData();var F=x.getFirstDayOfWeek();var z=x.getDaysStandAlone("narrow");for(i=0;i<z.length;i++){w=W[i];q(w).text(z[(i+F)%7])}}else{T._bLongWeekDays=true}m(T);var M=T.$("months").children();y=false;for(i=0;i<M.length;i++){var A=M[i];if(A.clientWidth<A.scrollWidth){y=true;break}}if(y){T._bLongMonth=false;if(!x){x=T._getLocaleData()}var B=x.getMonthsStandAlone("abbreviated");var E=T._getFocusedDate();T.$("month").text(B[E.getUTCMonth()])}else{T._bLongMonth=true}n(T);T._bNamesLengthChecked=true}}function v(T){if(T._bMouseMove){q(window.document).unbind('mousemove',T._mouseMoveProxy);T._bMouseMove=undefined}T.fireSelect()}}());return a},true);
