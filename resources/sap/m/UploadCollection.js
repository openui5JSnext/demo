/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./MessageBox','./MessageToast','./library','sap/ui/core/Control','sap/ui/unified/library'],function(q,M,a,l,C,b){"use strict";var U=C.extend("sap.m.UploadCollection",{metadata:{library:"sap.m",properties:{fileType:{type:"string[]",group:"Data",defaultValue:null},maximumFilenameLength:{type:"int",group:"Data",defaultValue:null},maximumFileSize:{type:"int",group:"Data",defaultValue:null},mimeType:{type:"string[]",group:"Data",defaultValue:null},multiple:{type:"boolean",group:"Behavior",defaultValue:false},noDataText:{type:"string",group:"Behavior",defaultValue:null},sameFilenameAllowed:{type:"boolean",group:"Behavior",defaultValue:false},showSeparators:{type:"sap.m.ListSeparators",group:"Appearance",defaultValue:sap.m.ListSeparators.None},uploadEnabled:{type:"boolean",group:"Behavior",defaultValue:true},uploadUrl:{type:"string",group:"Data",defaultValue:"../../../upload"}},defaultAggregation:"items",aggregations:{items:{type:"sap.m.UploadCollectionItem",multiple:true,singularName:"item"},headerParameters:{type:"sap.m.UploadCollectionParameter",multiple:true,singularName:"headerParameter"},parameters:{type:"sap.m.UploadCollectionParameter",multiple:true,singularName:"parameter"}},events:{change:{parameters:{documentId:{type:"string"}}},fileDeleted:{parameters:{documentId:{type:"string"}}},filenameLengthExceed:{parameters:{documentId:{type:"string"}}},fileRenamed:{parameters:{documentId:{type:"string"},fileName:{type:"string"}}},fileSizeExceed:{parameters:{documentId:{type:"string"},fileSize:{type:"string"}}},typeMissmatch:{parameters:{documentId:{type:"string"},fileType:{type:"string"},mimeType:{type:"string"}}},uploadComplete:{parameters:{readyStateXHR:{type:"string"},response:{type:"string"},status:{type:"string"}}}}}});
/*!
	 * (c) Copyright 2009-2014 SAP SE. All rights reserved
	 */
U.prototype.init=function(){sap.ui.getCore().loadLibrary("sap.ui.layout");sap.m.UploadCollection.prototype._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oList=new sap.m.List(this.getId()+"-list",{});this._oList.addStyleClass("sapMUCList")};U.prototype.onBeforeRendering=function(){var n=n||{};var N=N||this.getNoDataText();if(this.aItems){for(var i=0;i<this.getItems().length;i++){this.getItems()[i]._status=this.aItems[i]?this.aItems[i]._status:null;this.getItems()[i]._percentUploaded=this.aItems[i]?this.aItems[i]._percentUploaded:null}}this.aItems=this.getItems();n=this._getNumberOfAttachmentsLabel(this.aItems.length);if(!this.oHeaderToolbar){this.oHeaderToolbar=new sap.m.Toolbar(this.getId()+"-toolbar",{content:[n,new sap.m.ToolbarSpacer(),this._getFileUploader()]})}else{var t=this.oHeaderToolbar.getContent();t[0]=n;this.oHeaderToolbar.content=t}this.oHeaderToolbar.addStyleClass("sapMUCListHeader");if(this.getUploadUrl()!=this._oFileUploader.getUploadUrl()){this._oFileUploader.setProperty("uploadUrl",this.getUploadUrl(),true)}if(this.sErrorState!="Error"){if(this.getUploadEnabled()!=this._oFileUploader.getEnabled()){this._oFileUploader.setProperty("enabled",this.getUploadEnabled(),true)}}else{this._oFileUploader.setProperty("enabled",false,true)}if(this.getFileType()!=this._oFileUploader.getFileType()){this._oFileUploader.setProperty("fileType",this.getFileType(),true)}if(this.getMaximumFilenameLength()!=this._oFileUploader.getMaximumFilenameLength()){this._oFileUploader.setProperty("maximumFilenameLength",this.getMaximumFilenameLength(),true)}if(this.getMaximumFileSize()!=this._oFileUploader.getMaximumFileSize()){this._oFileUploader.setProperty("maximumFileSize",this.getMaximumFileSize(),true)}if(this.getMimeType()!=this._oFileUploader.getMimeType()){this._oFileUploader.setProperty("mimeType",this.getMimeType(),true)}if(this.getMultiple()!=this._oFileUploader.getMultiple()){this._oFileUploader.setProperty("multiple",this.getMultiple(),true)}if(this.getSameFilenameAllowed()!=this._oFileUploader.getSameFilenameAllowed()){this._oFileUploader.setProperty("sameFilenameAllowed",this.getSameFilenameAllowed(),true)}this._clearList();this._fillList(this.aItems);this._oList.setProperty("noDataText",N,true);this._oList.setHeaderToolbar(this.oHeaderToolbar);this._oList.setProperty("showSeparators",this.getShowSeparators(),true)};U.prototype.onAfterRendering=function(){var t=this;this._oList.aDelegates=[];if(this.aItems||(this.aItems==this.getItems())){if(this.editModeItem){var e=document.getElementById(this.editModeItem+"-ta_editFileName-inner");if(e){var i=this.editModeItem;e.focus();e.select();this._oList.addDelegate({onclick:function(E){sap.m.UploadCollection.prototype._handleClick(E,t,i)}})}}else{if(this.sFocusId){sap.m.UploadCollection.prototype._setFocus2LineItem(this.sFocusId);this.sFocusId=null}else if(this.sDeletedItemId){sap.m.UploadCollection.prototype._setFocusAfterDeletion(this.sDeletedItemId,t);this.sDeletedItemId=null}}}};U.prototype.exit=function(){if(this._oList){this._oList.destroy();this._oList=null}};U.prototype._mapItemToListItem=function(i){if(!i){return null}var I=i.getId(),p=i._percentUploaded,s=i._status,f=i.getFileName(),t=this,e=true;var B,o,c,E,d,F,u,P,T,g,h,j,k,m,n,H,L;if(s=="Uploading"){B=new sap.m.BusyIndicator(I+"-ia_indicator",{visible:true}).setSize('2.5rem').addStyleClass("sapMUCloadingIcon")}if(s=="Edit"){o=new sap.m.Button({id:I+"-okButton",text:this._oRb.getText("UPLOADCOLLECTION_OKBUTTON_TEXT"),type:sap.m.ButtonType.Transparent}).addStyleClass("sapMUCOkBtn");c=new sap.m.Button({id:I+"-cancelButton",text:this._oRb.getText("UPLOADCOLLECTION_CANCELBUTTON_TEXT"),type:sap.m.ButtonType.Transparent}).addStyleClass("sapMUCCancelBtn")}if(s=="Display"){e=i.getEnableEdit();if(this.sErrorState=="Error"){e=false}E=new sap.m.Button({id:I+"-editButton",icon:"sap-icon://edit",type:sap.m.ButtonType.Transparent,enabled:e,press:function(z){sap.m.UploadCollection.prototype._handleEdit(z,t)}}).addStyleClass("sapMUCEditBtn")}if(s=="Display"||s=="Uploading"){var r=I+"-deleteButton";if(s=="Uploading"){r=I+"-terminateButton"}e=i.getEnableDelete();if(this.sErrorState=="Error"){e=false}d=new sap.m.Button({id:r,icon:"sap-icon://sys-cancel",type:sap.m.ButtonType.Transparent,enabled:e}).addStyleClass("sapMUCDeleteBtn");if(s=="Uploading"){d.attachPress(function(z){sap.m.UploadCollection.prototype._handleTerminate(z,t)})}else{d.attachPress(function(z){sap.m.UploadCollection.prototype._handleDelete(z,t)})}}k=new sap.ui.layout.HorizontalLayout(I+"-ba_innerHL",{content:[o,c,E,d],allowWrapping:false}).addStyleClass("sapMUCBtnHL");if(s=="Display"||s=="Uploading"){e=true;if(this.sErrorState=="Error"){e=false}F=new sap.m.Link(I+"-ta_filenameHL",{text:f,enabled:e,href:i.getUrl()}).addStyleClass("sapMUCFileName")}if(s=="Display"){u=new sap.m.Label(I+"-ta_date",{text:i.getUploadedDate()+" "+i.getContributor()})}if(s=="Uploading"){P=new sap.m.Label(I+"-ta_progress",{text:this._oRb.getText("UPLOADCOLLECTION_UPLOADING",[p])}).addStyleClass("sapMUCProgress")}if(s=="Display"||s=="Uploading"){T=new sap.ui.layout.HorizontalLayout(I+"-ta_descriptionHL",{content:[u,P]}).addStyleClass("sapMUCDescriptionHL")}if(s=="Edit"){var v=U.prototype._splitFilename(f);var w=t.getMaximumFilenameLength();var V="None";var S=false;var x=v.name;if(i.errorState=="Error"){S=true;V="Error";x=i.changedFileName}g=new sap.m.Input(I+"-ta_editFileName",{type:sap.m.InputType.Text,valueState:V,valueStateText:this._oRb.getText("UPLOADCOLLECTION_EXISTS"),showValueStateMessage:S,value:x,description:v.extension}).addStyleClass("sapMUCEditBox");if((w-v.extension.length)>0){g.setProperty("maxLength",w-v.extension.length,true)}g.setLayoutData(new sap.m.FlexItemData({growFactor:1}));m=new sap.m.HBox(I+"-ta_extensionHL",{items:[g]}).addStyleClass("sapMUCEditHL")}n=new sap.ui.layout.VerticalLayout(I+"-ta_textVL",{content:[F,m,T],allowWrapping:true}).addStyleClass("sapMUCText");if(s=="Display"||s=="Edit"){var D=false;if(this.sErrorState=="Error"){D=true}j=i.getThumbnailUrl();if(j){h=new sap.m.Image(I+"-ia_imageHL",{src:sap.m.UploadCollection.prototype._getThumbnail(j,f),decorative:D,press:function(z){sap.m.UploadCollection.prototype._triggerLink(z)}}).addStyleClass("sapMUCItemImage")}else{h=new sap.ui.core.Icon(I+"-ia_iconHL",{src:sap.m.UploadCollection.prototype._getThumbnail(undefined,f),decorative:D,press:function(z){sap.m.UploadCollection.prototype._triggerLink(z)}}).setSize('2.5rem').addStyleClass("sapMUCItemIcon")}}H=new sap.ui.layout.HorizontalLayout(I+"-ta_HL",{content:[B,h,n,k],allowWrapping:false}).addStyleClass("sapMUCItemHL");if(s=="Edit"){H.addStyleClass("sapMUCEditMode")}else{H.removeStyleClass("sapMUCEditMode")}L=new sap.m.CustomListItem({content:[H]});for(var y in i.mProperties){if(i.mProperties.hasOwnProperty(y)){L.mProperties[y]=i.mProperties[y]}}L._status=s;L.addStyleClass("sapMUCItem");return L};U.prototype._fillList=function(i){var t=this;var m=i.length-1;q.each(i,function(I,o){if(!o._status){o._status="Display"}if(!o._percentUploaded){o._percentUploaded=0}var L=t._mapItemToListItem(o);if(I==0&&m==0){L.addStyleClass("sapMUCListSingleItem")}else if(I==0){L.addStyleClass("sapMUCListFirstItem")}else if(I==m){L.addStyleClass("sapMUCListLastItem")}else{L.addStyleClass("sapMUCListItem")}t._oList.addAggregation("items",L,true)})};U.prototype._clearList=function(){if(this._oList){this._oList.destroyAggregation("items",true)}};U.prototype._getNumberOfAttachmentsLabel=function(i){var n=i||0;if(!this.oNumberOfAttachmentsLabel){this.oNumberOfAttachmentsLabel=new sap.m.Label(this.getId()+"-numberOfAttachmentsLabel",{design:sap.m.LabelDesign.Standard,text:this._oRb.getText("UPLOADCOLLECTION_ATTACHMENTS",[n])})}else{this.oNumberOfAttachmentsLabel.setText(this._oRb.getText("UPLOADCOLLECTION_ATTACHMENTS",[n]))}return this.oNumberOfAttachmentsLabel};U.prototype._handleDelete=function(e,c){var p=e.getParameters();var I=c.getAggregation("items");var s=p.id.split("-deleteButton")[0];var d=null;var f="";c.sDeletedItemId=s;for(var i=0;i<I.length;i++){if(I[i].sId==s){d=i;break}}if(q.sap.byId(c.sId).hasClass("sapUiSizeCompact")){f="sapUiSizeCompact"}sap.m.MessageBox.show(this._oRb.getText("UPLOADCOLLECTION_DELETE_TEXT",I[d].getFileName()),{title:this._oRb.getText("UPLOADCOLLECTION_DELETE_TITLE"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(A){if(A===sap.m.MessageBox.Action.OK){c.fireFileDeleted({documentId:I[d].getDocumentId()})}},dialogId:"messageBoxDeleteFile",styleClass:f})};U.prototype._handleTerminate=function(e,c){var s="";if(q.sap.byId(c.sId).hasClass("sapUiSizeCompact")){s="sapUiSizeCompact"}sap.m.MessageBox.show(this._oRb.getText("UPLOADCOLLECTION_TERMINATE_TEXT"),{title:this._oRb.getText("UPLOADCOLLECTION_TERMINATE_TITLE"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(A){if(A===sap.m.MessageBox.Action.OK){c._getFileUploader().abort()}},dialogId:"messageBoxTerminateUploadFile",styleClass:s})};U.prototype._handleEdit=function(e,c){if(e.sId){var p=e.getParameters();var i=p.id;var I=i.split("-");var L=I.length;var s=I[L-2];c.aItems[s]._status="Edit";c.editModeItem=e.oSource.sId.split("-editButton")[0];c.invalidate()}};U.prototype._handleClick=function(e,c,s){if(e.target.id.lastIndexOf("editButton")>0){sap.m.UploadCollection.prototype._handleOk(e,c,s)}else if(e.target.id.lastIndexOf("cancelButton")>0){sap.m.UploadCollection.prototype._handleCancel(e,c,s)}else if(e.target.id.lastIndexOf("ia_imageHL")<0&&e.target.id.lastIndexOf("ia_iconHL")<0&&e.target.id.lastIndexOf("deleteButton")<0&&e.target.id.lastIndexOf("ta_editFileName")<0){if(e.target.id.lastIndexOf("ta_HL")>0){c.sFocusId=e.target.id}sap.m.UploadCollection.prototype._handleOk(e,c,s)}};U.prototype._handleOk=function(e,c,s){var t=true;var E=document.getElementById(s+"-ta_editFileName-inner");var n=E.value.replace(/^\s+/,"");if(!c.sFocusId){c.sFocusId=c.editModeItem+"-ta_HL"}if(n.length>0){var S=s.split("-").pop();c.aItems[S]._status="Display";var o=c.aItems[S].getProperty("fileName");var f=U.prototype._splitFilename(o);if(f.name!=n){if(!c.getSameFilenameAllowed()){var i=sap.ui.getCore().byId(s+"-ta_editFileName");if(sap.m.UploadCollection.prototype._checkDoubleFileName(n+f.extension,c.aItems)){var d=c.aItems[S].errorState;var g=c.aItems[S].changedFileName;i.setProperty("valueState","Error",true);c.aItems[S]._status="Edit";c.aItems[S].errorState="Error";c.aItems[S].changedFileName=n;c.sErrorState="Error";t=false;if(d!="Error"||g!=n){c.invalidate()}}else{i.setValueState="";c.aItems[S].errorState=null;c.aItems[S].changedFileName=null;c.sErrorState=null;c.editModeItem=null;c.invalidate()}}if(t){c.fireFileRenamed({documentId:c.aItems[S].getProperty("documentId"),fileName:n+f.extension})}}else{c.editModeItem=null;c.invalidate()}}};U.prototype._handleCancel=function(e,c,s){var S=s.split("-").pop();c.aItems[S]._status="Display";c.aItems[S].errorState=null;c.aItems[S].changedFileName=sap.ui.getCore().byId(s+"-ta_editFileName").getProperty("value");c.sFocusId=c.editModeItem+"-ta_HL";c.sErrorState=null;c.editModeItem=null;c.invalidate()};U.prototype._onChange=function(e){if(e){var t=this;this._oFileUploader.removeAllHeaderParameters();this._oFileUploader.removeAllParameters();var h=this.getAggregation("headerParameters");var p=this.getAggregation("parameters");var u=this._getUploadedFilesFromUploaderEvent(e);for(var i=0;i<u.length;i++){var I=new sap.m.UploadCollectionItem();I.setProperty("contributor",null);I.setDocumentId(null);I.setEnableDelete(true);I.setFileName(u[i]);I.setMimeType(null);I._status="Uploading";I._percentUploaded=0;I.setThumbnailUrl(null);I.setUploadedDate(null);I.setUrl(null);this.aItems.unshift(I);this.insertItem(I)}if(h){q.each(h,function(c,d){var H=new sap.ui.unified.FileUploaderParameter({name:d.getProperty("name"),value:d.getProperty("value")});t._oFileUploader.addHeaderParameter(H)})}if(p){q.each(p,function(c,d){var P=new sap.ui.unified.FileUploaderParameter({name:d.getProperty("name"),value:d.getProperty("value")});t._oFileUploader.addParameter(P)})}}};U.prototype._onFileAllowed=function(e){};U.prototype._onFileDeleted=function(e){};U.prototype._onFilenameLengthExceed=function(e){this.fireFilenameLengthExceed(e)};U.prototype._onFileSizeExceed=function(e){this.fireFileSizeExceed(e)};U.prototype._onTypeMissmatch=function(e){this.fireTypeMissmatch(e)};U.prototype._onUploadTerminated=function(e){};U.prototype._onUploadComplete=function(e){if(e){for(var i=0;i<this.aItems.length;i++){if(this.aItems[i]._status==="Uploading"){this.aItems[i]._status="Display"}}}this.fireUploadComplete(e)};U.prototype._onUploadProgress=function(e){if(e){var u=this._getUploadedFilesFromUploaderEvent(e);var p;var P;for(var i=0;i<u.length;i++){p=(Math.round(e.getParameter("loaded")/e.getParameter("total")*100)).toString();p=this._oRb.getText("UPLOADCOLLECTION_UPLOADING",[p]);P=q.sap.byId(this.aItems[i].getId()+"-ta_progress");P.text(p)}}};U.prototype._getFileUploader=function(){var t=this;if(!this._oFileUploader){this._oFileUploader=new sap.ui.unified.FileUploader(this.getId()+"-uploader",{buttonOnly:true,buttonText:" ",enabled:this.getUploadEnabled(),fileType:this.getFileType(),icon:"sap-icon://add",iconFirst:false,maximumFilenameLength:this.getMaximumFilenameLength(),maximumFileSize:this.getMaximumFileSize(),mimeType:this.getMimeType(),multiple:this.getMultiple(),name:"uploadCollection",sameFilenameAllowed:this.getSameFilenameAllowed(),uploadOnChange:true,uploadUrl:this.getUploadUrl(),useMultipart:false,sendXHR:true,change:function(e){t._onChange(e)},fileAllowed:function(e){t._onFileAllowed(e)},fileDeleted:function(e){t._onFileDeleted(e)},filenameLengthExceed:function(e){t._onFilenameLengthExceed(e)},fileRenamed:function(e){t._onFileRenamed(e)},fileSizeExceed:function(e){t._onFileSizeExceed(e)},typeMissmatch:function(e){t._onTypeMissmatch(e)},uploadAborted:function(e){t._onUploadTerminated(e)},uploadComplete:function(e){t._onUploadComplete(e)},uploadProgress:function(e){t._onUploadProgress(e)}})}return this._oFileUploader};U.prototype._getIconFromFilename=function(f){var F=this._splitFilename(f).extension;switch(F){case'.bmp':case'.jpg':case'.png':return'sap-icon://attachment-photo';case'.csv':case'.xls':case'.xlsx':return'sap-icon://excel-attachment';case'.doc':case'.docx':case'.odt':return'sap-icon://doc-attachment';case'.pdf':return'sap-icon://pdf-attachment';case'.ppt':case'.pptx':return'sap-icon://ppt-attachment';case'.txt':return'sap-icon://document-text';default:return'sap-icon://document'}};U.prototype._getThumbnail=function(t,f){if(t){return t}else{return this._getIconFromFilename(f)}};U.prototype._triggerLink=function(e){var L=null;if(e.oSource.sId.lastIndexOf("ia_iconHL")>0){L=e.oSource.sId.split("-ia_iconHL")[0]+"-ta_filenameHL"}else{L=e.oSource.sId.split("-ia_imageHL")[0]+"-ta_filenameHL"}q.sap.byId(L).click()};U.prototype.onkeydown=function(e){e.setMarked();switch(e.keyCode){case q.sap.KeyCodes.F2:sap.m.UploadCollection.prototype._handleF2(e,this);break;case q.sap.KeyCodes.ESCAPE:sap.m.UploadCollection.prototype._handleESC(e,this);break;case q.sap.KeyCodes.DELETE:sap.m.UploadCollection.prototype._handleDEL(e,this);break;case q.sap.KeyCodes.ENTER:sap.m.UploadCollection.prototype._handleENTER(e,this);break;default:return}};U.prototype._setFocusAfterDeletion=function(D,c){if(!D){return}var L=c.aItems.length;var s=null;if(L==0){var f=q.sap.byId(c._oFileUploader.sId);var F=f.find(":button");q.sap.focus(F)}else{var i=D.split("-").pop();if((L-1)>=i){s=D+"-ta_HL"}else{s=c.aItems.pop().sId+"-ta_HL"}sap.m.UploadCollection.prototype._setFocus2LineItem(s)}};U.prototype._setFocus2LineItem=function(f){if(!f){return}var o=q.sap.byId(f);var L=o.parentsUntil("ul");var F=L.filter("li");F.attr("tabIndex",-1);q.sap.focus(F)};U.prototype._handleENTER=function(e,c){var t=e.target.id.split(c.editModeItem).pop();switch(t){case"-ta_editFileName-inner":case"-okButton":sap.m.UploadCollection.prototype._handleOk(e,c,c.editModeItem);break;case"-cancelButton":sap.m.UploadCollection.prototype._handleCancel(e,c,c.editModeItem);break;default:return}};U.prototype._handleDEL=function(e,c){if(!c.editModeItem){var o=q.sap.byId(e.target.id);var d=o.find("[id$='-deleteButton']");var D=sap.ui.getCore().byId(d[0].id);if(D.getEnabled()){D.firePress()}}};U.prototype._handleESC=function(e,c){if(c.editModeItem){c.sFocusId=c.editModeItem+"-ta_HL";c.aItems[c.editModeItem.split("__item0-__collection0-")[1]]._status="Display";sap.m.UploadCollection.prototype._handleCancel(e,c,c.editModeItem)}};U.prototype._handleF2=function(e,c){var o=sap.ui.getCore().byId(e.target.id);var d=q.sap.byId(e.target.id);if(o!=undefined){if(o._status=="Display"){d=q.sap.byId(e.target.id);var f=d.find("[id$='-editButton']");var E=sap.ui.getCore().byId(f[0].id);if(E.getEnabled()){if(c.editModeItem){sap.m.UploadCollection.prototype._handleClick(e,c,c.editModeItem)}E.firePress()}}else{sap.m.UploadCollection.prototype._handleClick(e,c,c.editModeItem)}}else{if(e.target.id.search(c.editModeItem)==0){sap.m.UploadCollection.prototype._handleOk(e,c,c.editModeItem)}}};U.prototype._getUploadedFilesFromUploaderEvent=function(e){var u=e.getSource().getProperty("value");u=u.substring(1,u.length-2);var c=u.split(/\" "/);return c};U.prototype._checkDoubleFileName=function(f,I){if(I.length==0||!f){return false}var L=I.length;f=f.trimLeft();for(var i=0;i<L;i++){if(f==I[i].getProperty("fileName")){return true}}return false};U.prototype._splitFilename=function(f){var r={};var n=f.split(".");r.extension="."+n.pop();r.name=n.join(".");return r};return U},true);
